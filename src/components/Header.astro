---
import ThemeToggle from "./ThemeToggle.astro";
import { NAV_ITEMS, SITE } from "@/lib/constants";

const currentPath = Astro.url.pathname;
---

<header class="border-b border-border">
  <nav class="mx-auto flex max-w-4xl items-center justify-between px-6 py-5 sm:px-8">
    <a
      href="/"
      class="font-display text-xl font-black"
      style="font-variation-settings: 'opsz' 32, 'WONK' 1;"
    >
      {SITE.title}
    </a>

    {/* Desktop nav */}
    <div class="hidden items-center gap-6 sm:flex">
      {
        NAV_ITEMS.map((item) => (
          <a
            href={item.href}
            class:list={[
              "text-xs font-medium uppercase tracking-widest transition-colors",
              currentPath === item.href || (item.href !== "/" && currentPath.startsWith(item.href))
                ? "text-accent"
                : "text-text-secondary hover:text-text",
            ]}
          >
            {item.label}
          </a>
        ))
      }
      <ThemeToggle />
    </div>

    {/* Mobile toggle */}
    <div class="flex items-center gap-2 sm:hidden">
      <ThemeToggle />
      <button
        id="mobile-menu-toggle"
        type="button"
        aria-label="Apri menu"
        aria-expanded="false"
        class="p-2 transition-colors hover:bg-bg-secondary"
      >
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
      </button>
    </div>
  </nav>

  {/* Mobile menu */}
  <div id="mobile-menu" class="hidden border-t border-border sm:hidden">
    <div class="mx-auto max-w-4xl space-y-1 px-6 py-3 sm:px-8">
      {
        NAV_ITEMS.map((item) => (
          <a
            href={item.href}
            class:list={[
              "block px-3 py-2 text-xs font-medium uppercase tracking-widest transition-colors",
              currentPath === item.href || (item.href !== "/" && currentPath.startsWith(item.href))
                ? "bg-bg-secondary text-accent"
                : "text-text-secondary hover:bg-bg-secondary hover:text-text",
            ]}
          >
            {item.label}
          </a>
        ))
      }
    </div>
  </div>
</header>

<script>
  function setupMobileMenu() {
    const toggle = document.getElementById("mobile-menu-toggle");
    const menu = document.getElementById("mobile-menu");

    function closeMenu() {
      toggle?.setAttribute("aria-expanded", "false");
      menu?.classList.add("hidden");
    }

    toggle?.addEventListener("click", () => {
      const expanded = toggle.getAttribute("aria-expanded") === "true";
      toggle.setAttribute("aria-expanded", String(!expanded));
      menu?.classList.toggle("hidden");
    });

    menu?.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", closeMenu);
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && toggle?.getAttribute("aria-expanded") === "true") {
        closeMenu();
        toggle.focus();
      }
    });
  }
  setupMobileMenu();
  document.addEventListener("astro:after-swap", setupMobileMenu);
</script>
